---
- name: Deploy app from Jenkins GitHub clone to all servers
  hosts: webservers
  become: yes

  tasks:
    - name: Ensure app directory exists
      file:
        path: /home/sajja_vamsi/app
        state: directory
        mode: '0755'

    - name: Copy code from Jenkins workspace
      copy:
        src: "{{ playbook_dir }}/../"    # one level up, i.e. the repo root
        dest: /home/sajja_vamsi/app/
        mode: '0755'

    - name: Ensure Python 3 is installed
      apt:
        name: python3
        state: present
      become: yes

    - name: Ensure pip3 is installed
      apt:
        name: python3-pip
        state: present
      become: yes

    - name: Install Flask using pip3
      pip:
        name: flask
        executable: pip3
      become: yes

    - name: Run the app
      shell: |
        pkill -f "python3" || true
        nohup python3 /home/sajja_vamsi/app/app.py > /home/sajja_vamsi/app/log.txt 2>&1 &
      args:
        executable: /bin/bash
